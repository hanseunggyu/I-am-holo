{% extends "base.html" %}
{% block title %}ë‚´ ì´ìƒí˜• ì°¾ê¸°{% endblock %}

{% block content %}
<style>
  body {
    background: linear-gradient(135deg, #f3e7f3, #d4e0f0);
  }

  .panel.left {
    background-color: #e9d8fd;
    padding: 2rem;
    border-radius: 15px 0 0 15px;
    color: #4a148c;
  }

  .panel.right {
    background-color: #fffdfc;
    padding: 2rem;
    border-radius: 0 15px 15px 0;
    box-shadow: 0 0 10px rgba(0,0,0,0.05);
  }

  .btn-purple {
    background-color: #ba68c8;
    color: white;
  }

  .btn-purple:hover {
    background-color: #9c27b0;
    color: white;
  }

  .card {
    background-color: #fef5ff;
    border: none;
  }
</style>

<!-- âœ… Toast ì¶œë ¥ ì˜ì—­ -->
<div id="toast-container" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1050;"></div>

<!-- ì™¼ìª½ íŒ¨ë„ -->
<div class="panel left">
  <h2>ğŸ’˜ ë‚´ ì´ìƒí˜• ì°¾ê¸°</h2>
  <p>ì„±ë³„ê³¼ ë™ë¬¼ ì•„ì´ì½˜ìœ¼ë¡œ<br>ì´ìƒí˜•ì„ íƒìƒ‰í•´ë³´ì„¸ìš”!</p>
</div>

<!-- ì˜¤ë¥¸ìª½ íŒ¨ë„ -->
<div class="panel right d-flex flex-column">
  <!-- ì¡°ê±´ ì„ íƒ -->
  <div style="flex-shrink: 0;">
    <h2 class="mb-4">ì¡°ê±´ ì„ íƒ</h2>
    <form method="POST" class="row g-3 mb-4">
      <div class="col-md-6">
        <label class="form-label">ì„±ë³„</label>
        <select name="gender" class="form-select">
          <option value="">ì „ì²´</option>
          <option value="ë‚¨ì" {% if request.form.get('gender') == 'ë‚¨ì' %}selected{% endif %}>ë‚¨ì</option>
          <option value="ì—¬ì" {% if request.form.get('gender') == 'ì—¬ì' %}selected{% endif %}>ì—¬ì</option>
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">ë™ë¬¼ ì•„ì´ì½˜</label>
        <select name="animal" class="form-select">
          <option value="">ì „ì²´</option>
          {% for animal in ['ì‚¬ì','ì›ìˆ­ì´','ê³µë£¡','ì—¬ìš°','í† ë¼','ê°•ì•„ì§€','ê³ ì–‘ì´','ë‹¤ëŒì¥','ì‚¬ìŠ´','ê³°'] %}
          <option value="{{ animal }}" {% if request.form.get('animal') == animal %}selected{% endif %}>{{ animal }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- âœ… ì •ë ¬ ê¸°ì¤€ ì¶”ê°€ -->
      <div class="col-12">
        <label class="form-label">ì •ë ¬ ê¸°ì¤€</label>
        <select name="sort_by" class="form-select">
          <option value="recent" {% if request.form.get('sort_by') == 'recent' %}selected{% endif %}>ìµœê·¼ë“±ë¡ìˆœ</option>
          <option value="nickname" {% if request.form.get('sort_by') == 'nickname' %}selected{% endif %}>ì´ë¦„ìˆœ</option>
        </select>
      </div>

      <div class="col-12 text-center">
        <button type="submit" class="btn btn-purple w-100">íƒìƒ‰í•˜ê¸°</button>
      </div>
    </form>
  </div>

  <!-- í”„ë¡œí•„ ëª©ë¡ -->
  <div style="overflow-y: auto; max-height: 60vh; padding-right: 10px; flex-grow: 1;">
    {% if profiles %}
      {% for p in profiles %}
        <div class="card mb-3 shadow-sm" style="border-radius: 15px;">
          <div class="card-body">
            <h5 class="card-title">{{ p['nickname'] }} <small class="text-muted">({{ p['gender'] }})</small></h5>
            {% if p['is_online'] %}
              <span class="text-success">ğŸŸ¢ í™œë™ì¤‘</span>
            {% else %}
              <span class="text-muted">â›” íœ´ì‹ì¤‘</span>
            {% endif %}
            <p class="card-text" style="line-height: 1.5;">
              <strong>ë‚˜ì´:</strong> {{ p['age'] }}ì„¸<br>
              <strong>ë™ë¬¼:</strong> {{ p['animal_icon'] }}<br>
              <strong>MBTI:</strong> {{ p['mbti'] }}<br>
              <strong>ì‚¬ëŠ” ê³³:</strong> {{ p['location'] }}<br>
              <strong>ê¿ˆ/ëª©í‘œ:</strong> {{ p['dream'] }}<br>
              <strong>ì—°ì• ê´€:</strong> {{ p['love_style'] }}<br>
              <strong>ì·¨í–¥:</strong> {{ p['preference'] }}<br>
              <strong>í‚¤ì›Œë“œ:</strong> {{ p['keywords'] }}
            </p>

            {% if p['user_email'] in liked_users %}
              <button type="button" class="btn btn-outline-secondary btn-sm" onclick="unlikeUser('{{ p['user_email'] }}', this)">ğŸ’” ì¢‹ì•„ìš” ì·¨ì†Œ</button>
            {% else %}
              <button type="button" class="btn btn-outline-danger btn-sm" onclick="likeUser('{{ p['user_email'] }}', this)">ğŸ’– ì¢‹ì•„ìš”</button>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p class="text-muted">ğŸ™ˆ ì¡°ê±´ì— ë§ëŠ” ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
  </div>

  <!-- ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸° -->
  <div class="text-center mt-4" style="flex-shrink: 0;">
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
  </div>
</div>

<!-- âœ… Toast ë° Ajax ìŠ¤í¬ë¦½íŠ¸ -->
<script>
  function showToast(message) {
    const toastHTML = `
      <div class="toast align-items-center text-bg-success border-0 show"
           role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto"
                  data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>`;
    const wrapper = document.createElement('div');
    wrapper.innerHTML = toastHTML;
    document.getElementById('toast-container').appendChild(wrapper);
    const toast = new bootstrap.Toast(wrapper.querySelector('.toast'), { delay: 3000 });
    toast.show();
    setTimeout(() => wrapper.remove(), 3500);
  }

  function likeUser(to_email, btn) {
    fetch(`/like/${to_email}`, { method: 'POST' })
      .then(res => res.json())
      .then(data => {
        showToast(data.message || 'â¤ï¸ ì¢‹ì•„ìš” ì™„ë£Œ');
        btn.disabled = true;
        btn.innerText = 'â¤ï¸ ì´ë¯¸ ì¢‹ì•„ìš”í•¨';
        btn.classList.remove('btn-outline-danger');
        btn.classList.add('btn-secondary');
        btn.onclick = null;
      });
  }

  function unlikeUser(to_email, btn) {
    fetch(`/unlike/${to_email}`, { method: 'POST' })
      .then(res => res.json())
      .then(data => {
        showToast(data.message || 'ğŸ’” ì¢‹ì•„ìš” ì·¨ì†Œ ì™„ë£Œ');
        btn.disabled = true;
        btn.innerText = 'ğŸ’– ì¢‹ì•„ìš”';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-outline-danger');
        btn.onclick = null;
      });
  }
</script>

{% endblock %}

