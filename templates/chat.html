{% extends "base.html" %}
{% block title %}ì±„íŒ…{% endblock %}

{% block content %}
<div class="container py-4">
  <h4 class="mb-4">ğŸ’¬ <strong>{{ user_email }}</strong>ë‹˜ê³¼ì˜ ì±„íŒ…</h4>
  <!--ì‹ ê³  ì‚¬ìš©ì ë°•ìŠ¤-->
  {% if is_reported %}
    <div class="alert alert-danger text-center">
      ğŸš¨ ì´ ì‚¬ìš©ìëŠ” ì—¬ëŸ¬ ë²ˆ ì‹ ê³ ëœ ì‚¬ìš©ìì…ë‹ˆë‹¤.
    </div>
  {% endif %}

  <!-- ì±„íŒ… ë©”ì‹œì§€ ë°•ìŠ¤ -->
  <div id="chat-box" class="bg-white shadow-sm rounded p-3 mb-3" style="height: 350px; overflow-y: auto;">
    {% for sender, content, time in messages %}
      <div class="mb-2">
        <span class="fw-bold">{{ sender }}:</span>
        <span>{{ content }}</span>
        <span class="text-muted small">({{ time }})</span>
      </div>
    {% endfor %}
  </div>

  <!-- ë©”ì‹œì§€ ì…ë ¥ í¼ -->
  <form id="chat-form" class="input-group mb-4">
    <input id="msg-input" type="text" name="message" class="form-control" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." required autocomplete="off">
    <button type="submit" class="btn btn-primary">ì „ì†¡</button>
  </form>

  <!-- í•˜ë‹¨ ë²„íŠ¼ë“¤ -->
  <div class="d-flex gap-2">
    <form action="{{ url_for('matches') }}" method="GET">
      <button type="submit" class="btn btn-outline-secondary w-100">ğŸ”™ ì±„íŒ…ë°© ë‚˜ê°€ê¸°</button>
    </form>

    <form action="{{ url_for('unmatch', user_email=user_email) }}" method="POST" onsubmit="return confirm('ì •ë§ ë§¤ì¹­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
      <button type="submit" class="btn btn-outline-danger w-100">âŒ ë§¤ì¹­ ì·¨ì†Œ</button>
      </form>
      <form action="{{ url_for('report.report_user', reported_email=user_email) }}" method="POST" onsubmit="return confirm('ì´ ì‚¬ìš©ìë¥¼ ì‹ ê³ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
      <button type="submit" class="btn btn-outline-warning w-100">ğŸš© ì‹ ê³ í•˜ê¸°</button>
      </form>
  </div>
</div>

<!--ì´ë¯¸ ì‹ ê³ ëœ ì‚¬ëŒì…ë‹ˆë‹¤. ì•Œë¦¼ì°½-->
<script>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        alert("{{ message }}");
      {% endfor %}
    {% endif %}
  {% endwith %}
</script>

<!-- Socket.IO ìŠ¤í¬ë¦½íŠ¸ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js" crossorigin="anonymous"></script>
<script>
  const socket = io();
  const myEmail = "{{ my_email }}";
  const userEmail = "{{ user_email }}";
  const room = [myEmail, userEmail].sort().join("_");

  socket.emit('join', { my_email: myEmail, user_email: userEmail });

  document.getElementById('chat-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const input = document.getElementById('msg-input');
    const msg = input.value.trim();
    if (!msg) return;
    socket.emit('send_message', {
      my_email: myEmail,
      user_email: userEmail,
      message: msg
    });
    input.value = '';
  });

  socket.on('receive_message', function(data) {
    const box = document.getElementById('chat-box');
    const msgBlock = document.createElement('div');
    msgBlock.classList.add('mb-2');
    msgBlock.innerHTML = `<span class="fw-bold">${data.sender}:</span> ${data.content} <span class="text-muted small">(${data.timestamp})</span>`;
    box.appendChild(msgBlock);
    box.scrollTop = box.scrollHeight;
  });
</script>
{% endblock %}
