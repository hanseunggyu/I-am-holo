{% extends "base.html" %}
{% block title %}채팅{% endblock %}

{% block content %}
<div class="container py-4">
  <h4 class="mb-4">💬 <strong>{{ user_email }}</strong>님과의 채팅</h4>
  <!--신고 사용자 박스-->
  {% if is_reported %}
    <div class="alert alert-danger text-center">
      🚨 이 사용자는 여러 번 신고된 사용자입니다.
    </div>
  {% endif %}

  <!-- 채팅 메시지 박스 -->
  <div id="chat-box" class="bg-white shadow-sm rounded p-3 mb-3" style="height: 350px; overflow-y: auto;">
    {% for sender, content, time in messages %}
      <div class="mb-2">
        <span class="fw-bold">{{ sender }}:</span>
        <span>{{ content }}</span>
        <span class="text-muted small">({{ time }})</span>
      </div>
    {% endfor %}
  </div>

  <!-- 메시지 입력 폼 -->
  <form id="chat-form" class="input-group mb-4">
    <input id="msg-input" type="text" name="message" class="form-control" placeholder="메시지를 입력하세요..." required autocomplete="off">
    <button type="submit" class="btn btn-primary">전송</button>
  </form>

  <!-- 하단 버튼들 -->
  <div class="d-flex gap-2">
    <form action="{{ url_for('matches') }}" method="GET">
      <button type="submit" class="btn btn-outline-secondary w-100">🔙 채팅방 나가기</button>
    </form>

    <form action="{{ url_for('unmatch', user_email=user_email) }}" method="POST" onsubmit="return confirm('정말 매칭을 취소하시겠습니까?')">
      <button type="submit" class="btn btn-outline-danger w-100">❌ 매칭 취소</button>
      </form>
      <form action="{{ url_for('report.report_user', reported_email=user_email) }}" method="POST" onsubmit="return confirm('이 사용자를 신고하시겠습니까?')">
      <button type="submit" class="btn btn-outline-warning w-100">🚩 신고하기</button>
      </form>
  </div>
</div>

<!--이미 신고된 사람입니다. 알림창-->
<script>
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        alert("{{ message }}");
      {% endfor %}
    {% endif %}
  {% endwith %}
</script>

<!-- Socket.IO 스크립트 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js" crossorigin="anonymous"></script>
<script>
  const socket = io();
  const myEmail = "{{ my_email }}";
  const userEmail = "{{ user_email }}";
  const room = [myEmail, userEmail].sort().join("_");

  socket.emit('join', { my_email: myEmail, user_email: userEmail });

  document.getElementById('chat-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const input = document.getElementById('msg-input');
    const msg = input.value.trim();
    if (!msg) return;
    socket.emit('send_message', {
      my_email: myEmail,
      user_email: userEmail,
      message: msg
    });
    input.value = '';
  });

  socket.on('receive_message', function(data) {
    const box = document.getElementById('chat-box');
    const msgBlock = document.createElement('div');
    msgBlock.classList.add('mb-2');
    msgBlock.innerHTML = `<span class="fw-bold">${data.sender}:</span> ${data.content} <span class="text-muted small">(${data.timestamp})</span>`;
    box.appendChild(msgBlock);
    box.scrollTop = box.scrollHeight;
  });
</script>
{% endblock %}
