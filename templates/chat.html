{% extends "base.html" %}
{% block title %}ì±„íŒ…{% endblock %}

{% block content %}
<style>
  body {
    background: linear-gradient(to right, #f3e7f3, #d4e0f0);
  }

  #chat-box {
    height: 350px;
    overflow-y: auto;
    background: #ffffff;
    border-radius: 10px;
    padding: 1rem;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
  }

  #chat-form {
    display: flex;
    gap: 10px;
  }

  #msg-input {
    flex-grow: 1;
    border-radius: 25px;
    border: 1px solid #ccc;
    padding: 10px 20px;
    font-size: 0.95rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  #chat-form .btn {
    border: none;
    border-radius: 25px;
    padding: 10px 20px;
    background-color: #1d72f3;
    color: white;
    font-weight: bold;
    white-space: nowrap;
  }

  #chat-form .btn:hover {
    background-color: #155bd5;
  }

  #toast-container {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1050;
  }

  .toast-message {
    background-color: #ffeb3b;
    color: #000;
    padding: 10px 20px;
    border-radius: 8px;
    margin-top: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    font-weight: bold;
    animation: fadeout 3s forwards;
  }

  @keyframes fadeout {
    0% { opacity: 1; }
    80% { opacity: 1; }
    100% { opacity: 0; transform: translateY(-10px); }
  }

  .modal-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
  }

  .modal-content {
    max-width: 400px;
    width: 90%;
    background: #fff;
    padding: 20px 30px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
  }

  .modal-buttons {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    gap: 15px;
  }

  .btn-warning {
    background-color: #ffc107;
    border: none;
    padding: 8px 18px;
    border-radius: 6px;
    color: #000;
    font-weight: bold;
  }

  .btn-secondary {
    background-color: #6c757d;
    border: none;
    padding: 8px 18px;
    border-radius: 6px;
    color: #fff;
  }
</style>

<!-- âœ… Toast ì˜ì—­ -->
<div id="toast-container"></div>

<!-- âœ… ì‹ ê³  ëª¨ë‹¬ -->
<div id="report-modal" class="modal-overlay">
  <div class="modal-content">
    <p>ì´ ì‚¬ìš©ìë¥¼ ì‹ ê³ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
    <div class="modal-buttons">
      <button id="confirm-report" class="btn btn-warning">í™•ì¸</button>
      <button id="cancel-report" class="btn btn-secondary">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<!-- âœ… ë§¤ì¹­ì·¨ì†Œ ëª¨ë‹¬ -->
<div id="unmatch-modal" class="modal-overlay">
  <div class="modal-content">
    <p>ì •ë§ ë§¤ì¹­ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
    <div class="modal-buttons">
      <button id="confirm-unmatch" class="btn btn-warning">í™•ì¸</button>
      <button id="cancel-unmatch" class="btn btn-secondary">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<div class="container py-4">
  <h4 class="mb-4"><strong>{{ user_email }}</strong>ë‹˜ê³¼ì˜ ì±„íŒ…</h4>
  {% if is_reported %}
    <div class="alert alert-danger text-center">
      ğŸš¨ ì´ ì‚¬ìš©ìëŠ” ì—¬ëŸ¬ ë²ˆ ì‹ ê³ ëœ ì‚¬ìš©ìì…ë‹ˆë‹¤.
    </div>
  {% endif %}

  <div id="chat-box" class="bg-white shadow-sm rounded p-3 mb-3">
    {% for sender, content, time in messages %}
      <div class="mb-2">
        <span class="fw-bold">{{ sender }}:</span>
        <span>{{ content }}</span>
        <span class="text-muted small">({{ time }})</span>
      </div>
    {% endfor %}
  </div>

  <form id="chat-form" class="mb-4">
    <input id="msg-input" type="text" name="message" class="form-control" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." required autocomplete="off">
    <button type="submit" class="btn" style="height:45px;">ì „ì†¡</button>
  </form>

  <div class="d-flex gap-2">
    <form action="{{ url_for('matches') }}" method="GET">
      <button type="submit" class="btn btn-outline-secondary w-100">ì±„íŒ…ë°© ë‚˜ê°€ê¸°</button>
    </form>

    <form id="unmatch-form" action="{{ url_for('unmatch', user_email=user_email) }}" method="POST">
      <button type="button" class="btn btn-outline-danger w-100" id="unmatch-button">âŒ ë§¤ì¹­ ì·¨ì†Œ</button>
    </form>

    <form id="report-form" action="{{ url_for('report.report_user', reported_email=user_email) }}" method="POST">
      <button type="submit" class="btn btn-outline-warning w-100">ğŸš© ì‹ ê³ í•˜ê¸°</button>
    </form>
  </div>
</div>

<!-- âœ… Toast ë° ëª¨ë‹¬ Script -->
<script>
  function showToast(message) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast-message';
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => {
      toast.remove();
    }, 3000);
  }

  // ì‹ ê³  ëª¨ë‹¬
  const reportForm = document.getElementById('report-form');
  const reportModal = document.getElementById('report-modal');
  document.getElementById('cancel-report').onclick = () => reportModal.style.display = 'none';
  document.getElementById('confirm-report').onclick = () => {
    fetch(reportForm.action, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
    }).then(res => {
      if (res.ok) showToast('ğŸš¨ ì‹ ê³ í–ˆìŠµë‹ˆë‹¤!');
    });
    reportModal.style.display = 'none';
  };
  reportForm.onsubmit = (e) => {
    e.preventDefault();
    reportModal.style.display = 'flex';
  };

  // ë§¤ì¹­ ì·¨ì†Œ ëª¨ë‹¬
  const unmatchForm = document.getElementById('unmatch-form');
  const unmatchModal = document.getElementById('unmatch-modal');
  document.getElementById('unmatch-button').onclick = () => unmatchModal.style.display = 'flex';
  document.getElementById('cancel-unmatch').onclick = () => unmatchModal.style.display = 'none';
  document.getElementById('confirm-unmatch').onclick = () => {
    fetch(unmatchForm.action, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
    }).then(res => {
      if (res.ok) {
        showToast('âŒ ë§¤ì¹­ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        setTimeout(() => window.location.href = "{{ url_for('matches') }}", 1500);
      } else {
        showToast('âš ï¸ ë§¤ì¹­ ì·¨ì†Œ ì‹¤íŒ¨');
      }
    }).catch(() => showToast('âš ï¸ ì„œë²„ ì˜¤ë¥˜ ë°œìƒ'));
    unmatchModal.style.display = 'none';
  };
</script>

<!-- âœ… ì‹¤ì‹œê°„ ì±„íŒ… -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js" crossorigin="anonymous"></script>
<script>
  // 1) ì„œë²„ì™€ í†µì‹ í•  ë•Œ ì“¸ ì‚¬ìš©ì ì´ë©”ì¼ì€ ìµœìƒë‹¨ì— ì„ ì–¸í•©ë‹ˆë‹¤.
  const myEmail   = "{{ my_email }}";
  const userEmail = "{{ user_email }}";

  // 2) ì„œë²„ê°€ 5001ë²ˆ ë“± ë‹¤ë¥¸ í¬íŠ¸ì— ì˜¬ë¼ê°”ë‹¤ë©´ URLë„ ë§ì¶°ì£¼ì„¸ìš”.
  //    ex) const socket = io("http://localhost:5001");
  const socket = io();

  // 3) ì†Œì¼“ ì—°ê²° ì§í›„ì—ë§Œ join ì´ë²¤íŠ¸ë¥¼ ë³´ë‚´ë„ë¡
  socket.on('connect', () => {
    socket.emit('join', {
      my_email:   myEmail,
      user_email: userEmail
    });
  });

  // 4) ë©”ì‹œì§€ ì „ì†¡: myEmail/userEmail ë³€ìˆ˜ê°€ ë°–ì—ì„œ ì •ì˜ë¼ ìˆìœ¼ë‹ˆ ì´ì œ ì •ìƒ í˜¸ì¶œë©ë‹ˆë‹¤.
  document.getElementById('chat-form').addEventListener('submit', e => {
    e.preventDefault();
    const input = document.getElementById('msg-input');
    const msg   = input.value.trim();
    if (!msg) return;
    socket.emit('send_message', {
      my_email:   myEmail,
      user_email: userEmail,
      message:    msg
    });
    input.value = '';
  });

  // 5) ì„œë²„ì—ì„œ ë¸Œë¡œë“œìºìŠ¤íŠ¸ëœ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ë°”ë¡œ ì¶”ê°€
  socket.on('receive_message', data => {
    const box      = document.getElementById('chat-box');
    const msgBlock = document.createElement('div');
    msgBlock.classList.add('mb-2');
    msgBlock.innerHTML = `
      <span class="fw-bold">${data.sender}:</span>
      ${data.content}
      <span class="text-muted small">(${data.timestamp})</span>
    `;
    box.appendChild(msgBlock);
    box.scrollTop = box.scrollHeight;
  });

</script>
{% endblock %}


